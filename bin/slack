#!/usr/bin/env coffee

Slack = require '..'

token = process.argv[2]
if not token
  console.error "Token is required"
  process.exit 1
else
  shutdown = false
  slack = new Slack token

  slack.on 'error', (error) ->
    console.error 'Error: '+error
    process.exit 1

  slack.on 'open', ->
    console.log "Welcome to Slack. You are %s of %s", slack.self.name, slack.team.name
    channels = []
    for k of slack.channels
      channel = slack.channels[k]
      if channel.is_member then channels.push '#'+channel.name

    console.log "You are in: %s", channels.join(', ')

    groups = []
    for k of slack.groups
      group = slack.groups[k]
      if group.is_open and not group.is_archived then groups.push group.name

    if groups.length then console.log "As well as: %s", groups.join(', ')

  slack.on 'close', ->
    console.warn 'Disconnected!'
    if not shutdown then setTimeout slack.login(), 5000

  slack.on 'message', (message) ->
    str = message.toString()
    if str then console.log str

  process.on 'SIGINT', ->
    shutdown = true
    slack.disconnect()

  console.log 'Connecting...'
  slack.login()
